{% extends "layout.html" %}
{% block title %} Walletis - Rapports {% endblock %}

{% block content %}
<!-- Importation de Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .card-stat { background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: bold; margin-top: 0.5rem; }
    .text-green { color: #10b981; }
    .text-red { color: #ef4444; }
    .chart-container { position: relative; height: 300px; width: 100%; }
    .btn-export { background-color: #4f46e5; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; }
    .btn-export:hover { background-color: #4338ca; }
</style>

<div class="container mx-auto py-8 max-w-6xl">
    <div class="flex justify-end items-center mb-8">
        <button onclick="openModal('modal-export')" 
                class="flex items-center gap-2 bg-white border border-gray-300 px-4 py-2.5 rounded-xl text-sm font-semibold text-gray-700 hover:bg-gray-500 hover:text-white transition shadow-sm">
            <span>üì•</span> Exporter PDF
        </button>
    </div>

    <!-- Cartes Statistiques -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="card-stat">
            <p class="text-gray-500 text-sm">Revenus Totaux</p>
            <p class="stat-value text-green">+{{ total_revenu|floatformat:2 }} FCFA</p>
        </div>
        <div class="card-stat">
            <p class="text-gray-500 text-sm">D√©penses Totales</p>
            <p class="stat-value text-red">‚àí{{ total_depense|floatformat:2 }} FCFA</p>
        </div>
        <div class="card-stat">
            <p class="text-gray-500 text-sm">Solde Net</p>
            <p class="stat-value text-gray-800">{{ solde_net|floatformat:2 }} FCFA</p>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Graphique Cat√©gories -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-bold text-gray-700 mb-4">R√©partition des D√©penses par Compte</h3>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <!-- Graphique √âvolution -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-bold text-gray-700 mb-4">√âvolution Mensuelle</h3>
            <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="mt-8 text-center">
        <a href="{% url 'transaction' %}" class="text-indigo-600 hover:underline">‚Üê Retour aux transactions</a>
    </div>
</div>


<div id="modal-export" class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden">
        
        <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-indigo-50">
            <h3 class="text-xl font-bold text-indigo-800">Exporter les transactions</h3>
            <button onclick="closeModal('modal-export')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>

        <form class="p-6 space-y-4" method="post" action="{% url 'export_pdf' %}">
            {% csrf_token %}

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-3">
                    S√©lectionnez les comptes
                </label>

                <div class="space-y-2 max-h-40 overflow-y-auto">
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="comptes" value="all">
                            <span class="font-semibold text-indigo-600">Tous les comptes</span>
                        </label>
                    </div>

                    {% for compte in comptes %}
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="comptes" value="{{ compte.id }}">
                            <span>{{ compte.nom_compte }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <button type="submit"
            class="w-full bg-indigo-600 text-white font-bold py-3 rounded-2xl hover:bg-indigo-700 transition shadow-lg">
                T√©l√©charger le PDF
            </button>
        </form>
    </div>
</div>

{{ labels_categories|json_script:"labels-categories" }}
{{ data_categories|json_script:"data-categories" }}
{{ labels_months|json_script:"labels-months" }}
{{ data_income|json_script:"data-income" }}
{{ data_expense|json_script:"data-expense" }}
<script>
    const catLabels = JSON.parse(document.getElementById('labels-categories').textContent);
    const catData = JSON.parse(document.getElementById('data-categories').textContent);
    const monthLabels = JSON.parse(document.getElementById('labels-months').textContent);
    const incomeData = JSON.parse(document.getElementById('data-income').textContent);
    const expenseData = JSON.parse(document.getElementById('data-expense').textContent);

    // 1. Graphique Camembert (D√©penses par compte)
    const ctxCat = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctxCat, {
        type: 'doughnut',
        data: {
            labels: catLabels,
            datasets: [{
                data: catData,
                backgroundColor: [
                    '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#6366f1', '#8b5cf6'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // 2. Graphique Barres (Mensuel)
    const ctxMonth = document.getElementById('monthlyChart').getContext('2d');
    new Chart(ctxMonth, {
        type: 'bar',
        data: {
            labels: monthLabels,
            datasets: [
                {
                    label: 'Revenus',
                    data: incomeData,
                    backgroundColor: '#10b981',
                },
                {
                    label: 'D√©penses',
                    data: expenseData,
                    backgroundColor: '#ef4444',
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            },
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
    
    function openModal(id) {
        const modal = document.getElementById(id);
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Emp√™che le scroll derri√®re
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto'; // R√©active le scroll
    }

    // Fermer si on clique en dehors de la bo√Æte blanche
    window.onclick = function(event) {
        if (event.target.classList.contains('fixed')) {
            event.target.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    }

</script>
{% endblock %}