{% extends "layout.html" %}
{% block title %} Walletis - Transactions {% endblock %}

{% block content %}
<style>
    .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #f3f4f6; transition: background 0.2s; }
    .transaction-item:hover { background-color: #f9fafb; }
    .transaction-item:last-child { border-bottom: none; }
    /* Entrée = vert, Dépense = rouge */
    .amount-credit { color: #10b981; font-weight: 600; }
    .amount-debit { color: #ef4444; font-weight: 600; }
    .search-container { margin-bottom: 1.5rem; position: relative; }
    .search-input { width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none; }
.search-input:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
    .no-result { text-align: center; color: #6b7280; padding: 2rem; display: none; }
</style>

<div class="container mx-auto py-8 max-w-4xl">
    <!-- En-tête avec retour -->
    <div class="mb-6">
        <a href="{% url 'compte_list' %}" class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-md font-semibold text-xs text-gray-700 uppercase tracking-widest shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-25 transition ease-in-out duration-150">
            ← Retour aux comptes
        </a>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <!-- Informations du compte -->
        <div class="flex justify-between items-end mb-6 border-b pb-4">
            <div>
                <p class="text-gray-500 text-sm uppercase tracking-wide">Historique pour</p>
                <h1 class="text-2xl font-bold text-gray-800">
                    {% if compte_actif %}{{ compte_actif.nom_compte }}{% else %}Tous les comptes{% endif %}
                </h1>
            </div>
            <div class="text-right">
                <p class="text-gray-500 text-sm uppercase tracking-wide">Solde actuel</p>
                <p class="text-2xl font-bold text-gray-900">
                    {{ solde|floatformat:2 }} FCFA
                </p>
            </div>
        </div>

        <!-- Barre de recherche -->
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Rechercher une transaction (ex: Netflix, Salaire...)">
        </div>

        <!-- Liste des transactions -->
        <div id="transactionsList">
            <!-- Rempli par JS -->
        </div>
        
        <!-- Message si aucune transaction -->
        <div id="noResultMessage" class="no-result">
            Aucune transaction trouvée pour cette recherche.
        </div>
    </div>
</div>

{{ transactions_json|json_script:"transactions-data" }}
<script>
    // 1. Récupération des données Django (sécurisé)
    const transactionsData = JSON.parse(document.getElementById('transactions-data').textContent);
    
    // 2. Fonction pour formater la date (Optionnel, pour faire joli)
    function formatDate(dateString) {
        if (!dateString) return '';
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        return new Date(dateString).toLocaleDateString('fr-FR', options);
    }

    // 3. Fonction principale d'affichage
    function renderTransactions(filterText = '') {
        const listContainer = document.getElementById('transactionsList');
        const noResultMsg = document.getElementById('noResultMessage');
        listContainer.innerHTML = '';
        
        // Filtrage
        const filtered = transactionsData.filter(t => {
            const desc = (t.description || '').toLowerCase();
            return desc.includes(filterText.toLowerCase());
        });

        // Gestion "Aucun résultat"
        if (filtered.length === 0) {
            noResultMsg.style.display = 'block';
            return;
        } else {
            noResultMsg.style.display = 'none';
        }

        // Création des éléments HTML (Entrée = vert, Dépense = rouge)
        filtered.forEach(t => {
            const isEntree = (t.type || '').toUpperCase() === 'REVENU';
            const colorClass = isEntree ? 'amount-credit' : 'amount-debit';
            const sign = isEntree ? '+' : '−';
            const montant = parseFloat(t.montant);
            
            const row = document.createElement('div');
            row.className = 'transaction-item';
            row.innerHTML = `
                <div>
                    <div class="font-medium text-gray-800">${t.description || 'Transaction sans nom'}</div>
                    <div class="text-xs text-gray-500">${formatDate(t.date)} · ${isEntree ? 'Entrée' : 'Dépense'}</div>
                </div>
                <div class="${colorClass}">
                    ${sign} ${montant.toFixed(2)} FCFA
                </div>
            `;
            listContainer.appendChild(row);
        });
    }

    // 4. Écouteur pour la barre de recherche
    document.getElementById('searchInput').addEventListener('input', (e) => {
        renderTransactions(e.target.value);
    });

    // 5. Initialisation au chargement
    document.addEventListener('DOMContentLoaded', () => {
        renderTransactions();
    });
</script>
{% endblock %}